<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>满意度调查</title>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/toastr.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script>
        wx.config({
            debug: false,
            appId: 'wx7d8413cfab12360c',
            timestamp: '${Session.timestamp}',
            nonceStr: '${Session.nonceStr}',
            signature: '${Session.signature}',
            jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'onMenuShareQZone'] // 功能列表，分享相关
        });
        wx.ready(function () {
            // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。

            // 获取"分享到朋友圈"按钮点击状态及自定义分享内容接口
            wx.onMenuShareTimeline({
                title: '襄大同源物业公司满意度投票', // 分享标题
                link: 'http://xdwy.ixuhan.cn/jump.html',
                imgUrl: 'http://xdwy.ixuhan.cn/logo.png' // 分享图标
            });


            // 获取"分享给朋友"按钮点击状态及自定义分享内容接口
            wx.onMenuShareAppMessage({
                title: '襄大同源物业公司满意度投票', // 分享标题
                desc: '襄阳襄大同源物业服务有限公司成立于2014年3月，为湖北文理学院资产经营管理有限公司全资子公司，前身为湖北文理学院中原路与建华路校区物业管理处，现在按现代化物业管理制度全面运营。', // 分享描述
                link: 'http://xdwy.ixuhan.cn/jump.html',
                imgUrl: 'http://xdwy.ixuhan.cn/logo.png', // 分享图标
                type: 'link' // 分享类型,music、video或link，不填默认为link
            });


            //获取"分享到QQ"按钮点击状态及自定义分享内容接口
            wx.onMenuShareQQ({
                title: '襄大同源物业公司满意度投票', // 分享标题
                desc: '襄阳襄大同源物业服务有限公司成立于2014年3月，为湖北文理学院资产经营管理有限公司全资子公司，前身为湖北文理学院中原路与建华路校区物业管理处，现在按现代化物业管理制度全面运营。', // 分享描述
                link: 'http://xdwy.ixuhan.cn/jump.html',
                imgUrl: 'http://xdwy.ixuhan.cn/logo.png' // 分享图标
            });


            //获取"分享到腾讯微博"按钮点击状态及自定义分享内容接口
            wx.onMenuShareWeibo({
                title: '襄大同源物业公司满意度投票', // 分享标题
                desc: '襄阳襄大同源物业服务有限公司成立于2014年3月，为湖北文理学院资产经营管理有限公司全资子公司，前身为湖北文理学院中原路与建华路校区物业管理处，现在按现代化物业管理制度全面运营。', // 分享描述
                link: 'http://xdwy.ixuhan.cn/jump.html',
                imgUrl: 'http://xdwy.ixuhan.cn/logo.png' // 分享图标
            });


            //获取"分享到QQ空间"按钮点击状态及自定义分享内容接口
            wx.onMenuShareQZone({
                title: '襄大同源物业公司满意度投票', // 分享标题
                desc: '襄阳襄大同源物业服务有限公司成立于2014年3月，为湖北文理学院资产经营管理有限公司全资子公司，前身为湖北文理学院中原路与建华路校区物业管理处，现在按现代化物业管理制度全面运营。', // 分享描述
                link: 'http://xdwy.ixuhan.cn/jump.html',
                imgUrl: 'http://xdwy.ixuhan.cn/logo.png' // 分享图标
            });
        });
    </script>

    <link href="/css/toastr.css" rel="stylesheet" type="text/css">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        a:link, a:hover, a:active, a:visited {
            color: #4395F5;
            text-decoration: none;
        }

        #mask {
            display: none;
            position: absolute;
            top: 0px;
            background-color: #f8f8f8;
            z-index: 1002;
            left: 0px;
        }

        #voteArea {
        }

        .page-content {
            padding: 20px 15px 15px;
        }

        .item {
        }

        .title {
            margin-bottom: 10px;
            line-height: 1.4;
            font-weight: 400;
            font-size: 24px;
        }

        .description {
            margin-bottom: 18px;
            line-height: 20px;
            font-size: 0;
        }

        .desc-union {
            font-style: normal;
            color: #8c8c8c;
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 10px;
            font-size: 17px;
        }

        #commentPage {
            display: none;
            position: absolute;
            top: 0px;
            background-color: #f8f8f8;
            z-index: 1003;
            left: 0px;
            padding: 10px;
            width: 100%;
            text-align: center;
            margin: 0;
            padding: 0
        }

        .image1 {
            width: 46px;
            height: 46px;
            border-radius: 200px;
        }

        .name {
            border-bottom-width: 1px;
            border-bottom-style: solid;
            border-bottom-color: rgb(234, 234, 234);
            border-left-width: 1px;
            border-left-style: solid;
            border-left-color: rgb(234, 234, 234);
            border-right-width: 1px;
            border-right-style: solid;
            border-right-color: rgb(234, 234, 234);
        }

        .name_head {
            border-top-width: 1px;
            border-top-style: solid;
            border-top-color: rgb(234, 234, 234);
            box-sizing: border-box;
        }

        .option {
            border: dotted 1px rgb(234, 234, 234);
            /*border-top: none;*/
            margin-top: 0px;
            width: 100%;
        }

        .item {
            width: 100%;
            text-align: center;
            /*border-bottom: 1px rgb(234,234,234) solid;*/
            margin-bottom: 15px;
            /*padding: 10px 0 10px 13%;*/
            color: rgba(51, 51, 234, 0.5);
        }

        /*评论输入文本样式*/
        .content {
            width: 100%;
            height: 200px;
            padding: 10px;
            margin: 10px 0 15px 0;
            border: none;
            resize: none;
        }

        .comm_list {
            margin: 0 auto;
            width: 88%;
        }

        .comment {
            margin: 6% 0 7% 0;
        }
    </style>
</head>
<body onload="showStatus()">
<div id="navigation">
    <div class="page-content">
        <!--<div>Vote(共${totalCount!}票)</div>-->
        <div class="title">${Session.vote.name}</div><!--标题-->
        <div class="description">
            <em id="post-date" class="desc-union">2017-06-09</em>
            <em class="desc-union">同源物业有限公司</em>
        </div><!--投票时间、发起人等信息-->
        <section class="" style="line-height: 25.6px;white-space: normal;">
            <section class="" style="margin-top: 20px; font-family: 'microsoft YaHei'; border: 0px none;">
                <section style="text-align: center;">
                    <section>
                        <section class=""
                                 style="padding: 10px 10px 1px 10px; font-size: 18px; font-weight: bold; color: rgb(255, 255, 255); background: rgb(248, 170, 45);">
                            <p>襄阳襄大同源物业服务有限公司</p></section>
                    </section>
                </section>
            </section>
        </section>
        <!--<p style="line-height: 25.6px;white-space: normal;"><br></p>-->
        <p style="white-space: normal; line-height: 2em;"><strong>&nbsp;&nbsp;<span
                style="font-size: 14px;">&nbsp;${Session.vote.description}</span></strong></p>

        <br/>
        <section data-role="outer" label="Powered by 135editor.com"
                 style="font-size: 16px; line-height: 25.6px; white-space: normal; font-family: 微软雅黑;">
            <section class="" data-tools="135编辑器" data-id="89175" style="border: 0px none; box-sizing: border-box;">
                <section class="name_head">
                    <section class="name">
                        <p style="font-size: large;margin:5px 0 5px 0;" align="center" style="text-align: center;"><img
                                class="image1" src="${Session.headImg}"/>${NICKNAME}，
                            <#if (Session.voteRemain?number)==0>
                                您已投，谢谢！
                                <#else>
                                    诚邀您投票！
                            </#if>
                        </p>
                    </section>
                </section>
            </section>
        </section>
        <form id="${Session.vote.id}" method="post" action="record.do">
            <input type="hidden" name="voteId" value="${Session.vote.id}"/>
            <div id="voteArea" class="option">
                <#list Session.voteItems as item>
                    <div class="item">
                        <input type="radio" id="item${item.id}" name="vItemId" value="${item.id}"/>
                        <label for="item${item.id}"
                               style="width: 70px;font-family: '微软雅黑 light';font-size: 17px;padding-top: 10px;">${item.content}</label>
                    </div>
                </#list>
                <input id="submit" type="button" class="btn btn-primary"
                       style="width:25%;margin:0 auto;display:block;border:none;margin-bottom:20px;" onclick="record()"
                       value="提交">
            </div>
            <p align="center" style="color: #8c8c8c;margin-top: 10px">已有${totalCount}人参与投票</p>
        </form>
    </div>
    <!--<div class="progress" style="width: 150px;">
        <div class="progress-bar" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"
             style="width:20%">20%
        </div>
    </div>-->
    <br/>
    <div style="border-bottom: 1px solid lightgray;text-align: center;width: 36%;display: inline-block;float: left;margin-left: 4%"></div>
    <p style="border-bottom: none;position: relative;top: -10px;left: 3%;border: none;display: inline-block;color: #A48695;font-family: 微软雅黑;">
        精选留言</p>
    <div style="border-bottom: 1px solid lightgray;text-align: center;display: inline-block;float: right;width: 36%;margin-right: 4%"></div>

    <div>
        <div style="height: 20px;margin: -5% 4% 0 0;float: right">
            <a href="javascript:void(0)" onclick="showCommentPage()" style="font-size: 16px">写留言<span
                    style="font-size: 12px"
                    class="glyphicon glyphicon-pencil"></span></a>
        </div>
    </div>
    <div class="comm_list" id="comm_list">
        <div class="comments">
            <#list Session.voteComments as voteComment>
                <div class="comment">
                    <div>
                        <div>
                            <div style="display: inline"><img src="${voteComment.user_img}" height="30px" width="30px"/>
                            </div>
                            <div style="display: inline;color: #5e5e5e">${voteComment.nickname}</div>
                            <#if (voteComment.had_top)==0>
                                <div onclick='topup(this,${voteComment.id})'
                                     style='display: inline;float: right;color:#4395F5;cursor:pointer;float: right'>
                                    <span class='glyphicon glyphicon-thumbs-up'></span>&nbsp;&nbsp;<span
                                        class="top-count">${voteComment.top_count}</span>
                                </div>
                                <#else>
                                    <div onclick='topdown(this,${voteComment.id})'
                                         style='display: inline;float: right;color:#ffab29;cursor:pointer;float: right'>
                                        <span class='glyphicon glyphicon-thumbs-up'></span>&nbsp;&nbsp;<span
                                            class="top-count">${voteComment.top_count}</span>
                                    </div>
                            </#if>
                        </div>
                        <div style="margin-left: 35px;word-wrap: break-word;color: #3E444A;font-size: large">
                            ${voteComment.content}
                        </div>
                        <div style="margin-left: 35px;color: #BDBDBD">${voteComment.create_time}</div>
                    </div>
                </div>
            </#list>
        </div>
        <div class="comment" style="margin: 0 auto;"><p align="center" style="color: #8c8c8c;margin-top: 10px">
            留言将由公众号筛选后显示</p></div>
        <br/>
    </div>
</div>
<div id="mask"></div>
<div id="commentPage">
    <div style="font-size: 18px;margin-top: 10px">${Session.vote.name}</div>
    <textarea id="comm_content" name="voteComment.content" class="content"
              placeholder="留言将由公众号筛选后显示，对所有人可见。" oninput="checkSubmit()" maxlength="200"></textarea>
    <input type="button" id="comm_submit_btn" value="提交" onclick="addVoteComment()" class="btn btn-success"
           disabled="disabled" style="width: 96%;"/>
    <input type="button" value="返回" onclick="backComment()" class="btn btn-warning"
           style="width: 96%;margin-top: 5px;"/>
</div>
</body>
<script>
    /**
     * 判断是否应该显示结果
     */
    function showStatus() {
        if ("${Session.voteRemain?number}" == 0) {
            var itemStatus = ${Session.itemStatus!"null"};
            for (var key in itemStatus) {
                $("#item" + key).next("label").after("<progress style='progress-bar;margin-left:15px;' value="
                    + parseFloat(itemStatus[key].replace("%", ""))
                    + " max=100></progress>" + "<span style='margin-left: 10px;width: 56px;display: inline-block;font-family: '微软雅黑 light'>" + itemStatus[key] + "</span>");
                //alert("#item"+key);
                $("#item" + key).remove();
                $("#submit").remove();
            }
        }
        else {
            //alert("还可以投票");
        }
    }

    /**
     * ajax提交表单
     */
    function record() {
        if ($("input[name=vItemId]:checked").val() == undefined) {
            toastr.warning("请先作出您的选择");
            return;
        }
        $.ajax(
            {
                type: "POST",
                url: "record.do",
                dataType: "json",
                data: {"vItemId": $("input[name=vItemId]:checked").val()},
                async: true,
                success: function (data) {
                    toastr.option = {
                        positionClass: "toast-top-full-width"
                    };
                    if (data.msg == "ok")//投票成功
                    {
                        toastr.success("投票成功");
                        setTimeout("location.reload()", 2000);
                        /*setTimeout(function(){window.location.href=window.location.href+"?tm="+new Date().getTime()}, 2000);*/
                    }
                    else {
                        toastr.warning(data.msg);
                    }
                }
            });
    }

    /* getComments();
     /!**
     * 获得所有评论，ajax引入
     *!/
     function getComments(offset) {
     $.ajax({
     type:"POST",
     url:"comments.do",
     dataType:"json",
     data:{"voteId":"${vote.id}","offset":offset},
     success:function(data){
     return data;
     }
     })
     }*/

    /**
     * 显示遮罩层用于评论
     */
    function showMask() {
        $("#mask").css("height", $(window).height());
        $("#mask").css("width", $(window).width());
        $("#mask").show();
    }

    /**
     * 是否可以提交
     */
    function checkSubmit() {
        if ($("#comm_content").val().trim() != "") {
            $("#comm_submit_btn").removeAttr("disabled");
        }
        else {
            $("#comm_submit_btn").attr("disabled", "disabled");
        }
    }

    /**
     * 显示评论输入框
     */
    function showCommentPage() {
        showMask();
        $("#navigation").hide();
        $("#commentPage").show();
    }

    /**
     * 提交评论
     */
    function addVoteComment() {
        $.ajax({
            type: "POST",
            url: "addComment.do",
            dataType: "json",
            data: {
                "voteComment.content": $("#comm_content").val(),
                "voteComment.openid": "${Session.openid}",
                "voteComment.nickname": "${Session.NICKNAME}",
                "voteComment.userImg": "${Session.headImg}",
                "voteComment.voteId": "${Session.vote.id}"
            },
            async: "true",
            success: function () {
                toastr.success("已提交，等待审核");
                $("#mask").hide();
                $("#comm_content").val("");
                $("#commentPage").hide();
                $("#navigation").show();
            }
        });
    }

    function backComment() {
        $("#mask").hide();
        $("#commentPage").hide();
        $("#navigation").show();
    }

    function topdown(obj, id) {
        $.ajax({
            type: "POST",
            url: "topdown.do",
            dataType: "json",
            data: {"comm_id": id, "openid": "${Session.openid}"},
            async: "true",
            success: function (data) {
                if (data.msg == "ok") {
                    debugger;
                    var count = $(obj).find(".top-count").text();
                    $(obj).find(".top-count").text(parseInt(count) - 1);
                    $(obj).css("color", "#4395F5").attr("onclick", "topup(this," + id + ")");
                }
            }
        })
    }

    function topup(obj, id) {
        $.ajax({
            type: "POST",
            url: "topup.do",
            dataType: "json",
            data: {"comm_id": id, "openid": "${Session.openid}"},
            async: "true",
            success: function (data) {
                if (data.msg == "ok") {
                    debugger;
                    var count = $(obj).find(".top-count").text();
                    $(obj).find(".top-count").text(parseInt(count) + 1);
                    $(obj).css("color", "#ffab29").attr("onclick", "topdown(this," + id + ")");
                }
            }
        })
    }


    /**
     * 显示评论
     */
    /*var comm_index = 0;
     showComments(comm_index);
     function showComments(offset){
     var html;
     $.ajax({
     type:"POST",
     url:"comments.do",
     dataType:"json",
     data:{"voteId":"${vote.id}","offset":offset},
     success:function(comments){
     var showStr;
     if (comments!="")
     {
     for (var i = 0; i<comments.length; i++)
     {
     html = " <div class=\"comment\">"
     +"<div style='color:#4395F5;cursor:pointer;float: right'><span class='glyphicon glyphicon-thumbs-up'  onclick='toptop()'></span><span>&nbsp;&nbsp;"+comments[i].toptop+"</span></div>"
     +"<img src="+comments[i].userImg+" style=\"width: 40px;height: 40px\"/>"
     +"<p class=\"nickname\">"+comments[i].nickname+"</p>"
     +"<p class=\"comm_content\">"+comments[i].content+"</p>"
     +"<p class=\"comm_time\">"+comments[i].createTime+"</p>"
     +"</div>";
     }
     comm_index += 1;
     showStr = "<div id='show_more'><a href='javascript:void(0)' onclick='showComments("+comm_index+")'>显示更多...</a></div>";
     }
     else
     {
     //没有更多了
     showStr = "<div id='show_more'>没有更多了...</div>"
     }
     $("#show_more").remove();
     $("#comm_list").find(".comment").last().after(showStr).after(html);
     }
     })
     }*/

</script>
</html>