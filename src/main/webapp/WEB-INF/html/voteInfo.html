<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>这是投票页面</title>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/toastr.min.js"></script>


    <link href="/css/toastr.css" rel="stylesheet" type="text/css">
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        a:link, a:hover, a:active,a:visited{
            color: #4395F5;
            text-decoration: none;
        }

        #mask{
            display: none;
            position: absolute;
            top: 0px;
            background-color: #ffffff;
            z-index: 1002;
            left: 0px;
        }

        #voteArea {
            width: 300px;
            margin: 20px auto;
        }

        .page-content {
            padding: 20px 15px 15px;
        }

        .item {
        }

        .title {
            margin-bottom: 10px;
            line-height: 1.4;
            font-weight: 400;
            font-size: 24px;
        }

        .description {
            margin-bottom: 18px;
            line-height: 20px;
            font-size: 0;
        }

        .desc-union {
            font-style: normal;
            color: #8c8c8c;
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 10px;
            font-size: 17px;
        }

        #commentPage{
            display: none;
            position: absolute;
            top: 0px;
            background-color: #ffffff;
            z-index: 1003;
            left: 0px;
            padding:10px;
        }
    </style>
</head>
<body onload="showStatus()">
<div class="page-content">
    <!--<div>Vote(共${totalCount!}票)</div>-->
    <div class="title">${vote.name}</div><!--标题-->
    <div class="description">
        <em id="post-date" class="desc-union">2017-06-09</em>
        <em class="desc-union">襄大物业有限公司</em>
    </div><!--投票时间、发起人等信息-->

    <section class="" style="line-height: 25.6px;white-space: normal;">
        <section class="" style="margin-top: 20px; font-family: 'microsoft YaHei'; border: 0px none;">
            <section style="text-align: center;">
                <section>
                    <section class=""
                             style="padding: 10px 10px 1px 10px; font-size: 18px; font-weight: bold; color: rgb(255, 255, 255); background: rgb(248, 170, 45);">
                        <p>襄大物业满意度调查</p></section>
                </section>
            </section>
        </section>
    </section>
    <p style="line-height: 25.6px;white-space: normal;"><br></p>

    <form id="${vote.id}" method="post" action="record.do">
        <input type="hidden" name="voteId" value="${vote.id}">
        <div id="voteArea">
            <#list voteItems as item>
                <div class="item">
                    <input type="radio" id="item${item.id}" name="vItemId" value="${item.id}"/>
                    <label for="item${item.id}" style="width: 80px;">${item.content}</label>
                </div>
            </#list>
        </div>
        <input id="submit" type="button" onclick="record()" value="提交">
    </form>
    voteRemain = ${voteRemain!}
</div>
<div class="progress" style="width: 150px;">
    <div class="progress-bar" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"
         style="width:20%">20%
    </div>
</div>
<a href="javascript:void(0)" onclick="showCommentPage()" style="font-size: 16px">写留言<span style="font-size: 12px" class="glyphicon glyphicon-pencil"></span></a>
<div id="mask"></div>
<div id="commentPage">
    <div class="title">${vote.name}</div>
    <textarea id="comm_content" name="voteComment.content" class="content" placeholder="留言将由公众号筛选后显示，对所有人可见。"></textarea>
    <input type="button" value="提交" onclick="addVoteComment()"/>
</div>


<div class="comm_list" id="comm_list">
    <!--<div class="comment">
        <img src="" style="width: 100px;height: 100px"/>
        <p class="nickname"></p>
        <p class="comm_content"></p>
        <p class="comm_time"></p>
    </div>-->
    <div class="comment"></div>
</div>
</body>
<script>
    /**
     * 判断是否应该显示结果
     */
    function showStatus() {
        if ("${voteRemain!}" == "") {
            var itemStatus = ${itemStatus!"null"};
            for (var key in itemStatus) {
                $("#item" + key).next("label").after("<progress style='progress-bar' value="
                    + parseFloat(itemStatus[key].replace("%", ""))
                    + " max=100></progress>" + itemStatus[key]);
                //alert("#item"+key);
                $("#item" + key).remove();
                $("#submit").remove();
            }
        }
        else {
            //alert("还可以投票");
        }
    }

    /**
     * ajax提交表单
     */
    function record() {
        alert($("input[name=vItemId]:checked").val());
        $.ajax(
            {
                type: "POST",
                url: "record.do",
                dataType: "json",
                data: {"vItemId": $("input[name=vItemId]:checked").val()},
                async: true,
                success: function (data) {
                    alert(1);
                    toastr.option = {
                        positionClass: "toast-top-full-width"
                    };
                    if (data.msg == "ok")//投票成功
                    {
                        toastr.success("投票成功");
                        setTimeout("location.reload()", 2000);
                    }
                    else {
                        toastr.warning(data.msg);
                    }
                }
            });
    }

/*    getComments();
    /!**
     * 获得所有评论，ajax引入
     *!/
    function getComments(offset) {
        $.ajax({
            type:"POST",
            url:"comments.do",
            dataType:"json",
            data:{"voteId":"${vote.id}","offset":offset},
            success:function(data){
                return data;
            }
        })
    }*/

    /**
     * 显示遮罩层用于评论
     */
    function showMask()
    {
        $("#mask").css("height",$(document).height());
        $("#mask").css("width",$(document).width());
        $("#mask").show();
    }

    /**
     * 显示评论输入框
     */
    function showCommentPage() {
        showMask();
        $("#commentPage").show();
    }

    /**
     * 提交评论
     */
    function addVoteComment(){
        $.ajax({
            type: "POST",
            url:"addComment.do",
            dataType:"json",
            data:{"voteComment.content":$("#comm_content").val(),"voteComment.openid":"${openid}","voteComment.nickname":"${nickname}","voteComment.userImg":"${userImg}","voteComment.voteId":"${vote.id}"},
            async:"true",
            success:function (data) {
                alert(data);
            }
        });
    }
    /**
     * 显示评论
     */
    var comm_index = 0;
    showComments(comm_index);
    function showComments(offset){
        var html;
        $.ajax({
            type:"POST",
            url:"comments.do",
            dataType:"json",
            data:{"voteId":"${vote.id}","offset":offset},
            success:function(comments){
                var showStr;
                if (comments!="")
                {
                    for (var i = 0; i<comments.length; i++)
                    {
                        html = " <div class=\"comment\">"
                            +"<div style='color:#4395F5;cursor:pointer;float: right'><span class='glyphicon glyphicon-thumbs-up'  onclick='toptop()'></span><span>&nbsp;&nbsp;"+comments[i].toptop+"</span></div>"
                            +"<img src="+comments[i].userImg+" style=\"width: 40px;height: 40px\"/>"
                            +"<p class=\"nickname\">"+comments[i].nickname+"</p>"
                            +"<p class=\"comm_content\">"+comments[i].content+"</p>"
                            +"<p class=\"comm_time\">"+comments[i].createTime+"</p>"
                            +"</div>";
                    }
                    comm_index += 1;
                    showStr = "<div id='show_more'><a href='javascript:void(0)' onclick='showComments("+comm_index+")'>显示更多...</a></div>";
                }
                else
                {
                    //没有更多了
                    showStr = "<div id='show_more'>没有更多了...</div>"
                }
                $("#show_more").remove();
                $("#comm_list").find(".comment").last().after(showStr).after(html);
            }
        })
    }

</script>
</html>